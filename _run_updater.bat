@echo off
chcp 65001 > nul
echo.
echo ==================================================
echo               DPI GUI UPDATER
echo ==================================================
echo.
echo Этот скрипт скачает последнюю версию с GitHub,
echo скомпилирует ее и заменит текущие файлы.
echo.
echo ВНИМАНИЕ: Текущее окно программы будет закрыто!
echo.

REM Принудительно закрываем основное приложение, если оно запущено
taskkill /F /IM dpi_gui.exe > nul 2>&1

REM Запускаем Python-скрипт для скачивания и сборки
python update.py

REM Проверяем, успешно ли отработал скрипт
if %errorlevel% neq 0 (
    echo.
    echo !!! ПРОИЗОШЛА ОШИБКА НА ЭТАПЕ СКАЧИВАНИЯ/СБОРКИ. !!!
    echo Обновление отменено.
    goto end
)

echo.
echo --- УСТАНОВКА ОБНОВЛЕНИЯ ---
echo.

REM *** ИЗМЕНЕНО: Путь к новой сборке стал статичным ***
set "SOURCE_PATH=_update_temp\dist\dpi_gui"

REM Проверяем, существует ли папка
if not exist "%SOURCE_PATH%" (
    echo !!! Не удалось найти папку с новой сборкой: %SOURCE_PATH%
    goto end
)

echo -> Найдена новая версия в: %SOURCE_PATH%
echo -> Текущая директория: %cd%
echo.
echo -> Копирую файлы с заменой...

REM Копируем все содержимое новой папки в текущую с заменой
xcopy "%SOURCE_PATH%" "." /E /H /C /I /Y > nul

if %errorlevel% neq 0 (
    echo !!! ОШИБКА КОПИРОВАНИЯ ФАЙЛОВ.
    goto end
)

echo -> Копирование завершено.
echo.
echo -> Очищаю временные файлы...
rmdir /s /q _update_temp

echo.
echo ==================================================
echo      ОБНОВЛЕНИЕ УСПЕШНО ЗАВЕРШЕНО!
echo      Можно запускать dpi_gui.exe
echo ==================================================
echo.

:end
pause